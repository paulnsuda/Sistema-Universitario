// prisma/schema/base.prisma

generator client {
  provider = "prisma-client-js"
  // Eliminamos "multiSchema" porque ahora cada BD usará su schema "public" por defecto
  previewFeatures = ["prismaSchemaFolder"]
}

datasource db {
  provider = "postgresql"
  // Usaremos una variable genérica temporalmente para las migraciones
  url      = env("DATABASE_URL_TEMP")
}

// ==========================================
// MÓDULO USUARIOS (Irán a sistema_usuarios_db)
// ==========================================

model Rol {
  id_rol     Int          @id @default(autoincrement())
  nombre_rol String       @unique @db.VarChar(50)
  usuarios   Usuario[]
  permisos   RolPermiso[]

  @@map("roles")
}

model Permiso {
  id_permiso     Int          @id @default(autoincrement())
  nombre_permiso String       @unique @db.VarChar(100)
  clave          String       @unique @db.VarChar(50)
  roles          RolPermiso[]

  @@map("permisos")
}

model RolPermiso {
  id_rol     Int
  id_permiso Int
  rol        Rol     @relation(fields: [id_rol], references: [id_rol])
  permiso    Permiso @relation(fields: [id_permiso], references: [id_permiso])

  @@id([id_rol, id_permiso])
  @@map("roles_permisos")
}

model Usuario {
  id_usuario    Int           @id @default(autoincrement())
  nombres       String        @db.VarChar(100)
  apellidos     String        @db.VarChar(100)
  cedula        String        @unique @db.VarChar(20)
  email         String        @unique @db.VarChar(150)
  password      String
  fecha_creacion DateTime     @default(now())
  id_rol        Int
  rol           Rol           @relation(fields: [id_rol], references: [id_rol])
  // NOTA: Quitamos la relación inversa de inscripciones porque cruza fronteras de BD
  // inscripciones Inscripcion[] 

  @@map("usuarios")
}

// La tabla Inscripcion queda en la BD de Usuarios, pero pierde sus relaciones fuertes
model Inscripcion {
  id_inscripcion     Int      @id @default(autoincrement())
  fecha_inscripcion  DateTime @default(now())
  calificacion_final Decimal? @db.Decimal(4, 2)
  
  id_usuario         Int
  // Relación interna en la misma BD, esta sí se mantiene:
  usuario            Usuario  @relation(fields: [id_usuario], references: [id_usuario])

  // --- RELACIONES ROTAS (Cruzan a BD Carreras) ---
  // Solo guardamos los IDs como números simples. No hay @relation.
  id_materia         Int
  id_ciclo           Int
  // materia Materia @relation(...)  <-- ELIMINADO
  // ciclo   Ciclo   @relation(...)  <-- ELIMINADO

  @@map("inscripciones")
}


// ==========================================
// MÓDULO CARRERAS (Irán a sistema_carreras_db)
// ==========================================

model Carrera {
  id_carrera          Int       @id @default(autoincrement())
  nombre_carrera      String    @unique @db.VarChar(150)
  duracion_semestres  Int
  materias            Materia[]

  @@map("carreras")
}

model Materia {
  id_materia     Int               @id @default(autoincrement())
  nombre_materia String            @db.VarChar(150)
  creditos       Int
  id_carrera     Int
  carrera        Carrera           @relation(fields: [id_carrera], references: [id_carrera])
  // NOTA: Quitamos las relaciones inversas que cruzan fronteras
  // inscripciones  Inscripcion[]
  // profesores     ProfesorMateria[]

  @@map("materias")
}

model Ciclo {
  id_ciclo     Int           @id @default(autoincrement())
  nombre_ciclo String        @unique @db.VarChar(50)
  fecha_inicio DateTime?     @db.Date
  fecha_fin    DateTime?     @db.Date
  // NOTA: Quitamos la relación inversa
  // inscripciones Inscripcion[]

  @@map("ciclos")
}


// ==========================================
// MÓDULO PROFESORES (Irán a sistema_profesores_db)
// ==========================================

model Profesor {
  id_profesor Int               @id @default(autoincrement())
  nombres     String            @db.VarChar(100)
  apellidos   String            @db.VarChar(100)
  cedula      String            @unique @db.VarChar(20)
  email       String            @unique @db.VarChar(150)
  telefono    String?           @db.VarChar(20)
  titulos     Titulo[]
  // materias  ProfesorMateria[] <-- ELIMINADO (relación inversa)

  @@map("profesores")
}

model Titulo {
  id_titulo           Int      @id @default(autoincrement())
  nombre_titulo       String   @db.VarChar(150)
  institucion         String   @db.VarChar(150)
  fecha_obtencion     DateTime @db.Date
  registro_senescyt   String   @unique @db.VarChar(50)
  id_profesor         Int
  profesor            Profesor @relation(fields: [id_profesor], references: [id_profesor])

  @@map("titulos")
}

// Esta tabla pivote queda en la BD de Profesores, pero pierde la conexión fuerte con Materia
model ProfesorMateria {
  id          Int      @id @default(autoincrement())
  fecha_asignacion DateTime @default(now())

  id_profesor Int
  // Relación interna, se mantiene:
  profesor    Profesor @relation(fields: [id_profesor], references: [id_profesor])

  // --- RELACIÓN ROTA (Cruza a BD Carreras) ---
  id_materia  Int
  // materia  Materia @relation(...) <-- ELIMINADO

  @@unique([id_profesor, id_materia])
  @@map("profesor_materia")
}